# 字幕改行処理の改善提案

## 現在の問題

### 問題例
```
現在の出力:
"クロードコードが非常に安価になりました。\n
20ドルのProプランと200ドルのMaxプランで\n
API使用量としてではなく使えるようになったからです。\n
そのため、私の頼りになるコーディングエージェントとなりました。

問題点:
1. 「で」の後に不適切な改行
2. 文の途中での不自然な改行
3. 意味のまとまりを無視した改行
```

### 理想的な出力
```
"クロードコードが非常に安価になりました。\n
20ドルのProプランと200ドルのMaxプランでAPI使用量としてではなく使えるようになったからです。\n
そのため、私の頼りになるコーディングエージェントとなりました。
```

## 改善案

### 1. より具体的な改行ルールの追加

現在のルール:
- Do not break a line immediately after a comma (",", "、").

改善案:
- カンマ（「,」「、」）の直後で改行しない
- 助詞（「で」「に」「を」「は」「が」「と」「の」）の直後で改行しない  
- 「です」「ます」「だ」「である」の直後で改行しない（文末の場合を除く）
- 数字と単位の間で改行しない（例：「20ドル」「200MB」）
- 連体修飾句の途中で改行しない

### 2. 改行優先順位の明確化

優先度高（改行推奨）:
1. 句点（「。」）の後
2. 感嘆符・疑問符（「！」「？」）の後
3. 読点（「、」）の後（ただし意味のまとまりを考慮）

優先度中:
4. 長い複合文の接続詞の前（「しかし」「そのため」「また」）

優先度低（改行非推奨）:
5. 助詞の直後
6. 動詞・形容詞の活用語尾の途中

### 3. プロンプト改善案A（保守的）

```markdown
3. Subtitle text (text)
- Use `\\n` to break a line.
- Maximum of two lines per segment.
- Maximum of 25 characters per line is recommended for readability.
- Each segment should represent a complete thought or sentence.

## Line break rules (IMPORTANT):
- NEVER break immediately after: comma (",", "、"), particles ("で","に","を","は","が","と","の"), auxiliary verbs ("です","ます","だ","である")
- PREFER breaking after: periods ("。"), exclamation/question marks ("！","？")
- Keep numbers with their units together (e.g., "20ドル", "200MB")
- Maintain the natural flow of Japanese sentence structure

- Accurately reflect the intent and nuance of the original audio. Use natural and fluent Japanese, avoiding overly literal translations.
- Do not generate subtitles for silent sections, music-only sections, or audio fillers (e.g., "um", "uh", "er").
```

### 4. プロンプト改善案B（強化版）

```markdown
3. Subtitle text (text)
- Use `\\n` to break a line ONLY when it enhances readability.
- Maximum of two lines per segment.
- Aim for 20-30 characters per line for optimal readability.
- Each segment should represent a complete thought or sentence.

## Critical Line Break Rules:
### NEVER break after:
- Particles: で, に, を, は, が, と, の, へ, から, まで
- Auxiliary verbs: です, ます, だ, である (unless sentence ending)
- Commas: 、, (continue the clause)
- Numbers before units: 20[break]ドル ❌ → 20ドル ✅

### ALWAYS break after:
- Sentence endings: 。! ?
- Complete thoughts that exceed 30 characters

### Example of GOOD line breaks:
"クロードコードが安価になりました。\\n20ドルのProプランでAPI制限なく使えるからです。"

### Example of BAD line breaks:  
"クロードコードが安価に\\nなりました。20ドルのProプランで\\nAPI制限なく使えるからです。"

- Accurately reflect the intent and nuance of the original audio. Use natural and fluent Japanese, avoiding overly literal translations.
- Do not generate subtitles for silent sections, music-only sections, or audio fillers.
```

## 推奨実装

**段階的アプローチ**:
1. まず改善案A（保守的）でテスト
2. 結果を確認後、必要に応じて改善案B（強化版）を適用

## テスト方法

1. 現在問題のある動画で翻訳テスト
2. 改行位置の適切性を評価
3. 読みやすさの向上を確認
4. 必要に応じてプロンプトを微調整